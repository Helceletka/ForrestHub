{% extends "templates/base.html" %}
{% set game_name = "Investiční hra" %}
{% block content %}
    <div class="container-fluid">
        <!-- Sekce Investice a Vyhodnocení -->
        <div class="row">
            <!-- Sekce Investice -->
            <div class="col-md-6">
                <h2 class="underline-first-letter">Investice</h2>
                <div class="form-group">
                    <label for="amount">Investovaná částka:</label>
                    <input type="text" id="amount" class="form-control" placeholder="Zadejte částku" oninput="formatAsCurrency()" onkeypress="return isNumberKey(event)">
                </div>
                <div class="form-group">
                    <label for="risk">Míra rizika:</label>
                    <div class="btn-group risk-buttons" role="group">
                        <button id="riskA" type="button" class="btn btn-secondary risk-button" onclick="selectRisk('A')">A - Bezpečný</button>
                        <button id="riskS" type="button" class="btn btn-secondary risk-button" onclick="selectRisk('S')">S - Střední</button>
                        <button id="riskD" type="button" class="btn btn-secondary risk-button" onclick="selectRisk('D')">D - Nebezpečný</button>
                    </div>
                </div>
                <div id="fee-output" class="fee-output mt-3"></div>
                <button id="yes-button" class="btn btn-primary yes-button mt-3" onclick="confirmInvestment()">Ano</button>
                <button id="print-button" class="btn btn-primary print-button mt-3" onclick="printInvestment()">Tisk</button>
            </div>
            <!-- Sekce Vyhodnocení -->
            <div class="col-md-6">
                <h2 class="underline-first-letter">Vyhodnocení</h2>
                <div id="evaluation" class="evaluation-content" tabindex="0">
                    <div class="code-input d-flex mb-3">
                        <input type="text" maxlength="1" id="code1" class="form-control text-center" oninput="moveToNext(this, 'code2')">
                        <input type="text" maxlength="1" id="code2" class="form-control text-center" oninput="moveToNext(this, 'code3')">
                        <input type="text" maxlength="1" id="code3" class="form-control text-center" oninput="moveToNext(this, 'code4')">
                        <input type="text" maxlength="1" id="code4" class="form-control text-center" oninput="moveToNext(this, 'code5')">
                        <input type="text" maxlength="1" id="code5" class="form-control text-center" oninput="moveToNext(this)">
                    </div>
                    <div class="form-group">
                        <button id="preview-button" class="btn btn-primary preview-button" onclick="evaluateInvestment()">Náhled</button>
                        <button id="complete-button" class="btn btn-primary complete-button" onclick="completeInvestment()">Dokončit</button>
                    </div>
                    <div id="outcome-result" class="mt-3"></div>
                </div>
            </div>
        </div>
        <!-- Zobrazení velkého kódu a odměny -->
        <div id="large-code" class="large-code"></div>
        <div id="qrcode" class="mt-3"></div>
        <div id="large-reward" class="large-reward"></div>
        <!-- Sekce Logu -->
        <div id="log" class="log mt-4">
            <h3>Investiční Log</h3>
            <div id="log-content"></div>
        </div>
        <!-- Sekce Statistiky -->
        <div id="statistics" class="mt-4">
            <h3>Statistiky Investic</h3>
            <div id="statistics-content"></div>
        </div>
    </div>
    <!-- Přidání knihovny QRCode -->
    <script src="/assets/js/qrcode.min.js"></script>
    <script>
        let selectedRisk = '';
        let generatedCodes = new Set();
        let investments = [];

        const forbiddenChars = ['I', 'O', 'Y', 'C'];

        let forrestHub = new ForrestHubLib();

        function isNumberKey(evt) {
            let charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }

        function formatAsCurrency() {
            let input = document.getElementById('amount');
            let value = input.value;

            value = value.replace(/[^0-9]/g, '');

            let integerPart = value;

            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");

            input.value = integerPart;

            calculateFee(parseFloat(integerPart.replace(/\s+/g, '')));
        }

        function calculateFee(amount) {
            let feeOutput = document.getElementById('fee-output');
            let fee = 0;

            if (amount <= 100) {
                fee = Math.ceil(0.05 * amount);
            } else if (amount <= 1000) {
                fee = Math.ceil(0.10 * amount);
            } else if (amount <= 10000) {
                fee = Math.ceil(0.15 * amount);
            } else {
                fee = Math.ceil(0.20 * amount);
            }

            feeOutput.textContent = "Poplatek za investici: " + fee.toLocaleString() + " Ǥ";
        }

        function selectRisk(risk) {
            selectedRisk = risk;
            document.querySelectorAll('.risk-button').forEach(button => {
                button.classList.remove('selected');
            });
            document.getElementById('risk' + risk).classList.add('selected');
        }

        function generateUniqueCode() {
            let letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').filter(char => !forbiddenChars.includes(char));
            let code;

            do {
                code = '';
                for (let i = 0; i < 5; i++) {
                    code += letters[Math.floor(Math.random() * letters.length)];
                }
            } while (generatedCodes.has(code));

            generatedCodes.add(code);
            return code;
        }

        async function confirmInvestment() {
            let amount = document.getElementById('amount').value.replace(/\s+/g, '');
            if (!amount || !selectedRisk) {
                alert("Prosím zadejte částku a vyberte míru rizika.");
                return;
            }

            if (confirm("Opravdu chcete tuto investici provést?")) {
                investments = await forrestHub.getKey('investments', []);
                generatedCodes = new Set(investments.map(inv => inv.code));

                let uniqueCode = generateUniqueCode();
                let timestamp = new Date();

                let investment = {
                    code: uniqueCode,
                    amount: parseFloat(amount),
                    risk: selectedRisk,
                    startTime: timestamp.toISOString(),
                    fee: parseFloat(document.getElementById('fee-output').textContent.split(' ')[3])
                };

                investments.push(investment);

                await forrestHub.setKeyBroadcast('investments', investments);

                document.getElementById('large-code').textContent = "Kód investice: " + uniqueCode;

                // Vymazání předchozího QR kódu
                document.getElementById('qrcode').innerHTML = '';

                let address = `${window.location.origin}${window.location.pathname}?code=${uniqueCode}`;
                new QRCode(document.getElementById("qrcode"), address);

                clearInputs();
            }
        }

        function printInvestment() {
            let amount = document.getElementById('amount').value.replace(/\s+/g, '');
            if (!amount || !selectedRisk) {
                alert("Prosím zadejte částku a vyberte míru rizika.");
                return;
            }

            let fee = parseFloat(document.getElementById('fee-output').textContent.split(' ')[3]);
            let timestamp = new Date();
            let timeOnly = timestamp.toLocaleTimeString();

            let sharkTime = 4;
            let wolfTime = 8;
            let turtleTime = 12;

            let sharkReward, wolfReward, turtleReward;

            if (selectedRisk === 'A') {
                sharkReward = Math.ceil(1.4 * amount);
                wolfReward = Math.ceil(1.3 * amount);
                turtleReward = Math.ceil(1.25 * amount);
            } else if (selectedRisk === 'S') {
                sharkReward = Math.ceil(1.6 * amount);
                wolfReward = Math.ceil(1.4 * amount);
                turtleReward = Math.ceil(1.1 * amount);
            } else if (selectedRisk === 'D') {
                sharkReward = Math.ceil(2.05 * amount);
                wolfReward = Math.ceil(1.05 * amount);
                turtleReward = Math.ceil(0.55 * amount);
            }

            let printWindow = window.open('', '', 'width=600,height=400');
            printWindow.document.write(`
            <html>
            <head>
                <title>Gringottova kouzelnická banka</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    h1 { font-size: 24px; }
                    h2 { font-size: 18px; margin-top: 20px; }
                    p { font-size: 16px; margin: 5px 0; }
                </style>
            </head>
            <body>
                <h1>Gringottova kouzelnická banka</h1>
                <h2>Rekapitulace investice</h2>
                <p><strong>Investovaná částka:</strong> ${amount} Ǥ</p>
                <p><strong>Čas investice:</strong> ${timeOnly}</p>
                <p><strong>Zaplacené poplatky:</strong> ${fee} Ǥ</p>
                <p><strong>Míra rizika:</strong> ${selectedRisk}</p>
                <h2>Limity a možné odměny:</h2>
                <p><strong>Limitní čas pro Shark:</strong> ${sharkTime} minut</p>
                <p><strong>Možná odměna (při Shark):</strong> ${sharkReward} Ǥ</p>
                <p><strong>Limitní čas pro Wolf:</strong> ${wolfTime} minut</p>
                <p><strong>Možná odměna (při Wolf):</strong> ${wolfReward} Ǥ</p>
                <p><strong>Limitní čas pro Turtle:</strong> ${turtleTime} minut</p>
                <p><strong>Možná odměna (při Turtle):</strong> ${turtleReward} Ǥ</p>
                <p><strong>Limitní čas pro neúspěch:</strong> Nad ${turtleTime} minut</p>
            </body>
            </html>
        `);
            printWindow.document.close();
            printWindow.print();
        }

        function moveToNext(current, nextFieldId) {
            if (current.value.length === 1 && nextFieldId) {
                document.getElementById(nextFieldId).focus();
            }
        }

        function getCodeFromInputs() {
            return document.getElementById('code1').value +
                document.getElementById('code2').value +
                document.getElementById('code3').value +
                document.getElementById('code4').value +
                document.getElementById('code5').value;
        }

        function calculateReward(amount, risk, speed) {
            let multiplier = 1;
            if (risk === 'A') {
                if (speed === '🦈 shark') multiplier = 1.4;
                else if (speed === '🐺 wolf') multiplier = 1.3;
                else if (speed === '🐢 turtle') multiplier = 1.25;
                else multiplier = 1.0;
            } else if (risk === 'S') {
                if (speed === '🦈 shark') multiplier = 1.6;
                else if (speed === '🐺 wolf') multiplier = 1.4;
                else if (speed === '🐢 turtle') multiplier = 1.1;
                else multiplier = 0.5;
            } else if (risk === 'D') {
                if (speed === '🦈 shark') multiplier = 2.05;
                else if (speed === '🐺 wolf') multiplier = 1.05;
                else if (speed === '🐢 turtle') multiplier = 0.55;
                else multiplier = 0.0;
            }
            return Math.ceil(amount * multiplier);
        }

        function evaluateInvestment() {
            let code = getCodeFromInputs();

            let investment = investments.find(inv => inv.code === code);
            if (!investment) {
                alert("Investice s tímto kódem neexistuje.");
                return;
            }

            let now = new Date();
            let duration = (now - new Date(investment.startTime)) / 60000;

            let speed = '';
            if (duration <= 4) {
                speed = '🦈 shark';
            } else if (duration <= 8) {
                speed = '🐺 wolf';
            } else if (duration <= 12) {
                speed = '🐢 turtle';
            } else {
                speed = '❌ fail';
            }

            let reward = calculateReward(investment.amount, investment.risk, speed);

            document.getElementById('outcome-result').innerHTML = `
            <p>Investovaná částka: ${investment.amount} Ǥ</p>
            <p>Délka trvání: ${duration.toFixed(2)} minut (${speed})</p>
            <p>Míra rizika: ${investment.risk}</p>
            <p>Očekávaná odměna: ${reward.toLocaleString()} Ǥ</p>
        `;
        }

        async function completeInvestment() {
            let code = getCodeFromInputs();

            let index = investments.findIndex(inv => inv.code === code);
            if (index === -1) {
                alert("Investice s tímto kódem neexistuje.");
                return;
            }

            let investment = investments[index];
            let now = new Date();
            let duration = (now - new Date(investment.startTime)) / 60000;

            let speed = '';
            if (duration <= 4) {
                speed = '🦈 shark';
            } else if (duration <= 8) {
                speed = '🐺 wolf';
            } else if (duration <= 12) {
                speed = '🐢 turtle';
            } else {
                speed = '❌ fail';
            }

            let reward = calculateReward(investment.amount, investment.risk, speed);

            document.getElementById('large-reward').textContent = `Odměna: ${reward.toLocaleString()} Ǥ`;

            investments.splice(index, 1);

            await forrestHub.setKeyBroadcast('investments', investments);

            clearInputs();
        }

        function updateLog() {
            let logContent = document.getElementById('log-content');
            logContent.innerHTML = '';
            investments.forEach(inv => {
                let timestamp = new Date(inv.startTime);
                let timeOnly = timestamp.toLocaleTimeString();
                let logEntry = document.createElement('div');
                logEntry.id = `log-${inv.code}`;
                logEntry.classList.add('log-entry');

                let logText = document.createElement('span');
                logText.textContent = `Kód: ${inv.code}, Částka: ${inv.amount} Ǥ, Riziko: ${inv.risk}, Čas: ${timeOnly}`;
                logText.addEventListener('click', function() {
                    populateCodeInputs(inv.code);
                });

                let deleteButton = document.createElement('button');
                deleteButton.textContent = 'Smazat';
                deleteButton.classList.add('btn', 'btn-sm', 'btn-danger', 'ml-2');
                deleteButton.addEventListener('click', async function() {
                    if (confirm('Opravdu chcete smazat tuto investici?')) {
                        investments = investments.filter(i => i.code !== inv.code);
                        await forrestHub.setKeyBroadcast('investments', investments);
                    }
                });

                logEntry.appendChild(logText);
                logEntry.appendChild(deleteButton);
                logContent.appendChild(logEntry);
            });
        }

        function populateCodeInputs(code) {
            document.getElementById('code1').value = code.charAt(0);
            document.getElementById('code2').value = code.charAt(1);
            document.getElementById('code3').value = code.charAt(2);
            document.getElementById('code4').value = code.charAt(3);
            document.getElementById('code5').value = code.charAt(4);
        }

        function updateStatistics() {
            let totalInvestments = investments.length;
            let totalAmount = investments.reduce((sum, inv) => sum + inv.amount, 0);
            let totalFees = investments.reduce((sum, inv) => sum + inv.fee, 0);

            let statsContent = `
            <p>Celkový počet investic: ${totalInvestments}</p>
            <p>Celková investovaná částka: ${totalAmount.toLocaleString()} Ǥ</p>
            <p>Celkové poplatky: ${totalFees.toLocaleString()} Ǥ</p>
        `;

            document.getElementById('statistics-content').innerHTML = statsContent;
        }

        function clearInputs() {
            document.getElementById('amount').value = '';
            document.querySelectorAll('.risk-button').forEach(button => button.classList.remove('selected'));
            document.getElementById('code1').value = '';
            document.getElementById('code2').value = '';
            document.getElementById('code3').value = '';
            document.getElementById('code4').value = '';
            document.getElementById('code5').value = '';
            document.getElementById('fee-output').textContent = '';
            document.getElementById('outcome-result').innerHTML = '';
        }

        function getParameterByName(name) {
            let url = window.location.href;
            name = name.replace(/[[]]/g, "\\$&");
            let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        window.onload = async function() {
            investments = await forrestHub.getKey('investments', []);
            generatedCodes = new Set(investments.map(inv => inv.code));

            updateLog();
            updateStatistics();

            let codeParam = getParameterByName('code');
            if (codeParam && codeParam.length === 5) {
                populateCodeInputs(codeParam);
            }

            forrestHub.addEventListenerKey('investments', function(data) {
                investments = data;
                generatedCodes = new Set(investments.map(inv => inv.code));
                updateLog();
                updateStatistics();
            });
        };

        document.addEventListener('keydown', function(event) {
            let key = event.key.toLowerCase();

            if (key === 'i') {
                clearInputs();
                document.getElementById('amount').focus();
            } else if (key === 'o') {
                clearInputs();
                event.preventDefault();
                document.getElementById('code1').focus();
            } else if (key === 'a') {
                selectRisk('A');
            } else if (key === 's') {
                selectRisk('S');
            } else if (key === 'd') {
                selectRisk('D');
            } else if (key === 'y') {
                confirmInvestment();
            } else if (key === 'n') {
                evaluateInvestment();
            } else if (key === 'f') {
                completeInvestment();
            }
        });
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .underline-first-letter::first-letter {
            text-decoration: underline;
        }
        .risk-buttons .risk-button {
            margin-right: 5px;
        }
        .risk-button.selected {
            background-color: #007bff;
            color: white;
        }
        .large-code, .large-reward {
            font-size: 2em;
            text-align: center;
            margin-top: 20px;
            color: #007bff;
        }
        .log {
            margin-top: 20px;
            background-color: #f4f4f4;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
        }
        .code-input .form-control {
            width: 40px;
            margin-right: 5px;
            text-align: center;
            font-size: 1.2em;
        }
        .strike {
            text-decoration: line-through;
            color: red;
        }
        .log-entry {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .log-entry span {
            cursor: pointer;
        }
    </style>
{% endblock %}
