{% extends "templates/base.html" %}
{% set game_name = "Počítadlo vlivu týmů" %}
{% block content %}
    <div class="container-fluid">
        <h1 class="text-center mb-4">Počítadlo vlivu týmů</h1>
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-center align-items-center mb-2">
                    <button id="blueTeamMinus" class="btn btn-primary">-</button>
                    <span class="mx-2">Modrý tým</span>
                    <button id="blueTeamPlus" class="btn btn-primary">+</button>
                </div>
                <div id="blueTeamInfluence" class="d-flex influence-row"></div>
            </div>
            <div class="col">
                <div class="d-flex justify-content-center align-items-center mb-2">
                    <button id="redTeamMinus" class="btn btn-danger">-</button>
                    <span class="mx-2">Červený tým</span>
                    <button id="redTeamPlus" class="btn btn-danger">+</button>
                </div>
                <div id="redTeamInfluence" class="d-flex influence-row"></div>
            </div>
            <div class="col">
                <div class="d-flex justify-content-center align-items-center mb-2">
                    <button id="greenTeamMinus" class="btn btn-success">-</button>
                    <span class="mx-2">Zelený tým</span>
                    <button id="greenTeamPlus" class="btn btn-success">+</button>
                </div>
                <div id="greenTeamInfluence" class="d-flex influence-row"></div>
            </div>
            <div class="col">
                <div class="d-flex justify-content-center align-items-center mb-2">
                    <button id="yellowTeamMinus" class="btn btn-warning">-</button>
                    <span class="mx-2">Žlutý tým</span>
                    <button id="yellowTeamPlus" class="btn btn-warning">+</button>
                </div>
                <div id="yellowTeamInfluence" class="d-flex influence-row"></div>
            </div>
        </div>

        <div id="influenceBar" class="d-flex mt-4">
            <!-- Dynamická vizualizace vlivu týmů (25 políček, každé má 12 segmentů) -->
            {% for i in range(25) %}
                <div class="influence-cell d-flex" id="cell-{{ i }}">
                    {% for j in range(12) %}
                        <div class="influence-segment"></div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    </div>

    <script>
        forrestHubLib = window.forrestHubLib || new ForrestHubLib();
        const influenceCells = Array.from(document.querySelectorAll('.influence-cell'));
        const influenceData = {
            blue: 0,
            red: 0,
            green: 0,
            yellow: 0
        };

        // Aktualizace vizualizace vlivu podle segmentů
        function updateInfluenceBar() {
            influenceCells.forEach((cell, index) => {
                const segments = Array.from(cell.querySelectorAll('.influence-segment'));
                segments.forEach(segment => segment.style.backgroundColor = 'grey'); // Reset

                const activeTeams = [];
                if (index < influenceData.blue) activeTeams.push('blue');
                if (index < influenceData.red) activeTeams.push('red');
                if (index < influenceData.green) activeTeams.push('green');
                if (index < influenceData.yellow) activeTeams.push('yellow');

                if (activeTeams.length === 1) {
                    // Jeden tým má celý vliv
                    segments.forEach(segment => segment.style.backgroundColor = activeTeams[0]);
                } else if (activeTeams.length === 2) {
                    // Dva týmy mají vliv, každý 6 segmentů
                    for (let i = 0; i < 6; i++) {
                        segments[i].style.backgroundColor = activeTeams[0];
                    }
                    for (let i = 6; i < 12; i++) {
                        segments[i].style.backgroundColor = activeTeams[1];
                    }
                } else if (activeTeams.length === 3) {
                    // Tři týmy, každý má 4 segmenty
                    for (let i = 0; i < 4; i++) {
                        segments[i].style.backgroundColor = activeTeams[0];
                    }
                    for (let i = 4; i < 8; i++) {
                        segments[i].style.backgroundColor = activeTeams[1];
                    }
                    for (let i = 8; i < 12; i++) {
                        segments[i].style.backgroundColor = activeTeams[2];
                    }
                } else if (activeTeams.length === 4) {
                    // Čtyři týmy, každý má 3 segmenty
                    for (let i = 0; i < 3; i++) {
                        segments[i].style.backgroundColor = activeTeams[0];
                    }
                    for (let i = 3; i < 6; i++) {
                        segments[i].style.backgroundColor = activeTeams[1];
                    }
                    for (let i = 6; i < 9; i++) {
                        segments[i].style.backgroundColor = activeTeams[2];
                    }
                    for (let i = 9; i < 12; i++) {
                        segments[i].style.backgroundColor = activeTeams[3];
                    }
                }
            });
        }

        // Tlačítka pro modifikaci vlivu týmů
        document.getElementById('blueTeamPlus').addEventListener('click', () => {
            if (influenceData.blue < 25) influenceData.blue++;
            updateInfluenceBar();
            forrestHubLib.setKeyBroadcast('blueTeamInfluence', influenceData.blue);
        });
        document.getElementById('blueTeamMinus').addEventListener('click', () => {
            if (influenceData.blue > 0) influenceData.blue--;
            updateInfluenceBar();
            forrestHubLib.setKeyBroadcast('blueTeamInfluence', influenceData.blue);
        });

        document.getElementById('redTeamPlus').addEventListener('click', () => {
            if (influenceData.red < 25) influenceData.red++;
            updateInfluenceBar();
            forrestHubLib.setKeyBroadcast('redTeamInfluence', influenceData.red);
        });
        document.getElementById('redTeamMinus').addEventListener('click', () => {
            if (influenceData.red > 0) influenceData.red--;
            updateInfluenceBar();
            forrestHubLib.setKeyBroadcast('redTeamInfluence', influenceData.red);
        });

        document.getElementById('greenTeamPlus').addEventListener('click', () => {
            if (influenceData.green < 25) influenceData.green++;
            updateInfluenceBar();
            forrestHubLib.setKeyBroadcast('greenTeamInfluence', influenceData.green);
        });
        document.getElementById('greenTeamMinus').addEventListener('click', () => {
            if (influenceData.green > 0) influenceData.green--;
            updateInfluenceBar();
            forrestHubLib.setKeyBroadcast('greenTeamInfluence', influenceData.green);
        });

        document.getElementById('yellowTeamPlus').addEventListener('click', () => {
            if (influenceData.yellow < 25) influenceData.yellow++;
            updateInfluenceBar();
            forrestHubLib.setKeyBroadcast('yellowTeamInfluence', influenceData.yellow);
        });
        document.getElementById('yellowTeamMinus').addEventListener('click', () => {
            if (influenceData.yellow > 0) influenceData.yellow--;
            updateInfluenceBar();
            forrestHubLib.setKeyBroadcast('yellowTeamInfluence', influenceData.yellow);
        });

        // Načti počáteční hodnoty
        forrestHubLib.getKey('blueTeamInfluence', 0).then(value => influenceData.blue = value || 0);
        forrestHubLib.getKey('redTeamInfluence', 0).then(value => influenceData.red = value || 0);
        forrestHubLib.getKey('greenTeamInfluence', 0).then(value => influenceData.green = value || 0);
        forrestHubLib.getKey('yellowTeamInfluence', 0).then(value => influenceData.yellow = value || 0);

        // Aktualizace při změně hodnot na serveru
        forrestHubLib.addEventListenerKey('blueTeamInfluence', (value) => { influenceData.blue = value; updateInfluenceBar(); });
        forrestHubLib.addEventListenerKey('redTeamInfluence', (value) => { influenceData.red = value; updateInfluenceBar(); });
        forrestHubLib.addEventListenerKey('greenTeamInfluence', (value) => { influenceData.green = value; updateInfluenceBar(); });
        forrestHubLib.addEventListenerKey('yellowTeamInfluence', (value) => { influenceData.yellow = value; updateInfluenceBar(); });

        updateInfluenceBar(); // Inicializace
    </script>

    <style>
        /* Úprava pro dynamickou šířku */
        .influence-row {
            height: 30px;
            margin-bottom: 10px;
        }
        .influence-cell {
            flex: 1;
            height: 30px;
            display: flex;
            margin-right: 2px;
        }
        .influence-segment {
            flex: 1;
            height: 100%;
            background-color: grey; /* Defaultní barva */
            margin-right: 1px;
        }
    </style>
{% endblock %}
