{% extends "templates/base.html" %}
{% set game_name = "Pošta - Přepážka" %}
{% block content %}
    <div class="container">
        <h1>Poštovní přepážka</h1>
        <p>Celkový počet čekajících: <span id="total_count">0</span></p>
        <p>Vyberte kategorii:</p>
        <button id="accept_prijem" class="btn btn-primary">Příjem <span class="badge bg-light text-dark" id="prijem_count">0</span></button>
        <button id="accept_odeslani" class="btn btn-secondary">Odeslání <span class="badge bg-light text-dark" id="odeslani_count">0</span></button>
        <button id="accept_los" class="btn btn-success">Los <span class="badge bg-light text-dark" id="los_count">0</span></button>
        <div id="current_ticket" style="margin-top: 20px;"></div>
        <div id="queue_count" style="margin-top: 10px;"></div>
        <button id="complete_button" class="btn btn-danger" style="display:none;">Vyřízeno</button>
    </div>

    <script>
        const forrestLib = new ForrestHubLib();
        let currentQueue = null;

        const updateTotalCount = () => {
            Promise.all([
                forrestLib.getKey('prijem_queue'),
                forrestLib.getKey('odeslani_queue'),
                forrestLib.getKey('los_queue')
            ]).then(([prijem, odeslani, los]) => {
                const prijemCount = prijem ? prijem.length : 0;
                const odeslaniCount = odeslani ? odeslani.length : 0;
                const losCount = los ? los.length : 0;
                const totalCount = prijemCount + odeslaniCount + losCount;

                document.getElementById('total_count').innerText = totalCount;
                document.getElementById('prijem_count').innerText = prijemCount;
                document.getElementById('odeslani_count').innerText = odeslaniCount;
                document.getElementById('los_count').innerText = losCount;
            });
        };

        const showNextTicket = (queue) => {
            forrestLib.getKey(queue).then((queueData = []) => {
                if (queueData.length > 0) {
                    const nextTicket = queueData[0];
                    document.getElementById('current_ticket').innerHTML = `
                        <h2>Číslo ${nextTicket.number}</h2>
                        <p>Kategorie: ${queue.replace('_queue', '')}</p>
                        <p>Čas: ${nextTicket.time}</p>
                    `;
                    document.getElementById('queue_count').innerHTML = `<p>Počet čekajících: ${queueData.length}</p>`;
                    document.getElementById('complete_button').style.display = 'block';
                    currentQueue = queue;
                } else {
                    document.getElementById('current_ticket').innerHTML = '<p>Fronta je prázdná.</p>';
                    document.getElementById('queue_count').innerHTML = '';
                    document.getElementById('complete_button').style.display = 'none';
                }
            });
        };

        document.getElementById('accept_prijem').addEventListener('click', () => showNextTicket('prijem_queue'));
        document.getElementById('accept_odeslani').addEventListener('click', () => showNextTicket('odeslani_queue'));
        document.getElementById('accept_los').addEventListener('click', () => showNextTicket('los_queue'));

        document.getElementById('complete_button').addEventListener('click', () => {
            forrestLib.getKey(currentQueue).then((queueData = []) => {
                queueData.shift(); // Odeber první lísteček
                return forrestLib.setKeyBroadcast(currentQueue, queueData);
            }).then(() => {
                document.getElementById('current_ticket').innerHTML = '<p>Lísteček vyřízen.</p>';
                document.getElementById('complete_button').style.display = 'none';
                updateTotalCount();
            });
        });

        // Aktualizuj počty čekajících při změně fronty pomocí addEventListenerKey
        forrestLib.addEventListenerKey('prijem_queue', (data) => {
            const count = data ? data.length : 0;
            document.getElementById('prijem_count').innerText = count;
            updateTotalCount();
        });

        forrestLib.addEventListenerKey('odeslani_queue', (data) => {
            const count = data ? data.length : 0;
            document.getElementById('odeslani_count').innerText = count;
            updateTotalCount();
        });

        forrestLib.addEventListenerKey('los_queue', (data) => {
            const count = data ? data.length : 0;
            document.getElementById('los_count').innerText = count;
            updateTotalCount();
        });

        // Načti počáteční počty čekajících
        updateTotalCount();
    </script>
{% endblock %}
