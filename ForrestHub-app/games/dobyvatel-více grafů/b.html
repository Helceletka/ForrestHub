{% extends "templates/base.html" %}
{% set game_name = "Obsazování území - Odesílací stránka" %}
{% block content %}
    <div class="container mt-4">
        <h1 class="text-center mb-4">Obsazování území - Odesílací stránka</h1>
        <p>Název odesílací stránky: <span id="device_name"></span></p>
        <div id="teamButtons" class="d-flex justify-content-around mb-4">
            <!-- Tlačítka týmů budou generována zde -->
        </div>
        <p>Aktuální tým: <span id="current_team">Žádný</span></p>

        <!-- Zobrazení grafu -->
        <div class="mt-5">
            <canvas id="territoryChart"></canvas>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        forrestHubLib = window.forrestHubLib || new ForrestHubLib();

        let deviceName
        if (!document.location.search) {
            deviceName = 'device_' + Math.floor(Math.random() * 10000);
            document.location.search = `?device=${deviceName}`;
        } else {
            deviceName = new URLSearchParams(document.location.search).get('device');
        }
        let activeTeam = null;
        let teamTimes = {};
        let lastUpdate = Date.now();
        let teamNames = [];
        let territoryChart;

        document.getElementById('device_name').innerText = deviceName;

        forrestHubLib.getKey('game_config').then((config) => {
            if (config) {
                teamNames = config.teamNames;
                initialize();
            } else {
                alert('Konfigurace není nastavena.');
            }
        });

        async function initialize() {
            teamNames.forEach(name => {
                teamTimes[name] = 0;
            });
            generateTeamButtons();
            initializeChart();
            forrestHubLib.getKey(deviceName).then((times) => {
                if (times) teamTimes = times;
                updateChart();
            });
            setInterval(updateTimes, 1000);
        }

        function generateTeamButtons() {
            const container = document.getElementById('teamButtons');
            container.innerHTML = '';
            teamNames.forEach((name, index) => {
                const button = document.createElement('button');
                button.classList.add('btn', 'btn-primary', 'm-1');
                button.textContent = name;
                button.onclick = () => assignTeam(name);
                container.appendChild(button);
            });
        }

        function initializeChart() {
            const ctx = document.getElementById('territoryChart').getContext('2d');
            territoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: teamNames,
                    datasets: [{
                        data: teamNames.map(() => 0),
                        backgroundColor: teamNames.map((_, i) => `hsl(${i * 360 / teamNames.length}, 70%, 50%)`),
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(2);
                                    return `${label}: ${value.toFixed(1)}s (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function updateTimes() {
            const now = Date.now();
            if (activeTeam) {
                const slowdown = await forrestHubLib.getKey('slowdown', 100);
                teamTimes[activeTeam] += (now - lastUpdate) / slowdown;
            }
            lastUpdate = now;
            await forrestHubLib.setKey(deviceName, teamTimes);
            updateChart();
        }

        function assignTeam(team) {
            updateTimes();
            activeTeam = team;
            document.getElementById("current_team").innerText = team;
            forrestHubLib.setKey(deviceName, teamTimes);
        }

        function updateChart() {
            const times = teamNames.map(name => teamTimes[name] || 0);
            territoryChart.data.datasets[0].data = times;
            territoryChart.update();
        }
    </script>
{% endblock %}
