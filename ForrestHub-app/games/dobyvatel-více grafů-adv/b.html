{% extends "templates/base.html" %}
{% set game_name = "Obsazování území - Tabule" %}
{% block content %}
    <div class="container">
        <h1 class="text-center mb-4">Stav obsazení území ze všech zařízení</h1>
        <div id="charts-container" class="d-flex flex-wrap justify-content-around">
            <!-- Grafy jednotlivých zařízení -->
        </div>
    </div>

    <!-- Načtení knihovny Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        forrestHubLib = window.forrestHubLib || new ForrestHubLib();
        const maxDevices = 5;
        let deviceCharts = {};

        function createChart(deviceName) {
            const container = document.getElementById('charts-container');
            const chartDiv = document.createElement('div');
            chartDiv.classList.add('m-3');
            chartDiv.innerHTML = `<h3>${deviceName}</h3><canvas id="chart_${deviceName}"></canvas>`;
            container.appendChild(chartDiv);

            const ctx = document.getElementById(`chart_${deviceName}`).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Tým A', 'Tým B', 'Tým C', 'Tým D'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['blue', 'green', 'yellow', 'red'],
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(2);
                                    return `${label}: ${value}s (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            deviceCharts[deviceName] = chart;
        }

        function updateChart(deviceName, teamTimes) {
            const totalTime = Object.values(teamTimes).reduce((a, b) => a + b, 0) || 1;
            const normalizedTimes = Object.values(teamTimes).map(time => (time / totalTime) * 100);

            if (deviceCharts[deviceName]) {
                deviceCharts[deviceName].data.datasets[0].data = normalizedTimes;
                deviceCharts[deviceName].update();
            }
        }

        function loadAllDevices() {
            forrestHubLib.getAllDatabase().then((data) => {
                const devices = Object.keys(data).slice(0, maxDevices); // Omezíme na maxDevices zařízení
                devices.forEach((deviceName) => {
                    if (!deviceCharts[deviceName]) {
                        createChart(deviceName);
                    }
                    updateChart(deviceName, data[deviceName]);
                });
            });
        }

        forrestHubLib.addEventListenerKey('team_times', () => {
            loadAllDevices(); // Načteme data při každé změně
        });

        setInterval(loadAllDevices, 5000); // Načítání každých 5 sekund
    </script>
{% endblock %}
