{% extends "templates/base.html" %}
{% set game_name = "Obsazování území - Odesílací stránka" %}
{% block content %}
    <div class="container mt-4">
        <h1 class="text-center mb-4">Obsazování území - Odesílací stránka</h1>
        <p>Název odesílací stránky: <span id="device_name"></span></p>
        <div class="d-flex justify-content-around mb-4">
            <button class="btn btn-primary" onclick="assignTeam('A')">Tým A</button>
            <button class="btn btn-success" onclick="assignTeam('B')">Tým B</button>
            <button class="btn btn-warning" onclick="assignTeam('C')">Tým C</button>
            <button class="btn btn-danger" onclick="assignTeam('D')">Tým D</button>
        </div>
        <p>Aktuální tým: <span id="current_team">Žádný</span></p>

        <!-- Zobrazení grafu -->
        <div class="mt-5">
            <canvas id="territoryChart"></canvas>
        </div>
    </div>

    <!-- Načtení knihovny Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        forrestHubLib = window.forrestHubLib || new ForrestHubLib();
        const deviceName = 'device_' + Math.floor(Math.random() * 10000);
        let activeTeam = null;
        let teamTimes = { A: 0, B: 0, C: 0, D: 0 };
        let lastUpdate = Date.now();

        // Zobrazení náhodně generovaného názvu
        document.getElementById('device_name').innerText = deviceName;

        // Inicializace grafu
        const ctx = document.getElementById('territoryChart').getContext('2d');
        const territoryChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Tým A', 'Tým B', 'Tým C', 'Tým D'],
                datasets: [{
                    data: [0, 0, 0, 0],
                    backgroundColor: ['blue', 'green', 'yellow', 'red'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (context) => {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(2);
                                return `${label}: ${value}s (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });

        function updateTimes() {
            const now = Date.now();
            if (activeTeam) {
                teamTimes[activeTeam] += (now - lastUpdate) / 1000; // Přičítání času v sekundách
            }
            lastUpdate = now;
            forrestHubLib.setKeyBroadcast(deviceName, teamTimes); // Posíláme data pod jménem zařízení
            updateChart();
        }

        function assignTeam(team) {
            updateTimes();
            activeTeam = team;
            document.getElementById("current_team").innerText = team;
            forrestHubLib.setKeyBroadcast(deviceName, teamTimes);
        }

        function updateChart() {
            const totalTime = Object.values(teamTimes).reduce((a, b) => a + b, 0) || 1;
            const normalizedTimes = Object.values(teamTimes).map(time => (time / totalTime) * 100);

            territoryChart.data.datasets[0].data = normalizedTimes;
            territoryChart.update();
        }

        forrestHubLib.getKey(deviceName).then((times) => {
            if (times) teamTimes = times; // Načítáme předchozí data při obnovení stránky
            updateChart();
        });

        setInterval(updateTimes, 1000); // Aktualizace každou sekundu
    </script>
{% endblock %}
